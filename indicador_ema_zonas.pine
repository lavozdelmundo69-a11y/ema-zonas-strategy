// INDICADOR: EMA 3/22 + Zonas de Liquidez/Order Blocks Mitigadas
// Muestra seÃ±ales visuales cuando:
// - Cruce EMA 3/22
// - Previamente se mitigÃ³ una zona (liquidez u Order Block) en ventana de N barras
// No ejecuta trades; solo visualizaciÃ³n
//@version=6
indicator("EMA 3/22 + Zonas OB/Liq (SeÃ±ales)", overlay=true)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARÃMETROS (defaults alineados con backtest agresivo)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
fast_ema_len = input.int(3, "EMA RÃ¡pida", group="ğŸ“Š EMAs")
slow_ema_len = input.int(22, "EMA Lenta", group="ğŸ“Š EMAs")
bars_window = input.int(20, "Ventana post-mitigaciÃ³n (barras)", minval=1, maxval=50,
     tooltip="MÃ¡ximo barras despuÃ©s de mitigar zona para considerar vÃ¡lido el cruce")

use_liq = input.bool(true, "Detectar Zonas de Liquidez", group="ğŸ” Condiciones")
use_ob = input.bool(true, "Detectar Order Blocks", group="ğŸ” Condiciones")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIQUIDEZ (Swing Highs/Lows)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
group_liq = "ğŸ”¹ Zonas de Liquidez"
swing_len = input.int(8, "Longitud Swing High/Low", group=group_liq, minval=5, maxval=50)
liq_tolerance = input.float(0.5, "Tolerancia MitigaciÃ³n (%)", group=group_liq, minval=0.1, step=0.1)
max_zonas = input.int(20, "MÃ¡ximo Zonas Visual", group=group_liq, minval=5, maxval=50)

top = ta.pivothigh(high, swing_len, swing_len)
bot = ta.pivotlow(low, swing_len, swing_len)

var float[] liq_highs = array.new_float(0)
var float[] liq_lows = array.new_float(0)
var int[] liq_high_bars = array.new_int(0)
var int[] liq_low_bars = array.new_int(0)
var bool[] liq_high_mitigated = array.new_bool(0)
var bool[] liq_low_mitigated = array.new_bool(0)
var int[] liq_high_mitig_bar = array.new_int(0)
var int[] liq_low_mitig_bar = array.new_int(0)

if not na(top)
    array.push(liq_highs, top)
    array.push(liq_high_bars, bar_index[swing_len])
    array.push(liq_high_mitigated, false)
    array.push(liq_high_mitig_bar, -1)

if not na(bot)
    array.push(liq_lows, bot)
    array.push(liq_low_bars, bar_index[swing_len])
    array.push(liq_low_mitigated, false)
    array.push(liq_low_mitig_bar, -1)

// Limitar tamaÃ±o
if array.size(liq_highs) > max_zonas
    array.shift(liq_highs)
    array.shift(liq_high_bars)
    array.shift(liq_high_mitigated)
    array.shift(liq_high_mitig_bar)

if array.size(liq_lows) > max_zonas
    array.shift(liq_lows)
    array.shift(liq_low_bars)
    array.shift(liq_low_mitigated)
    array.shift(liq_low_mitig_bar)

// Verificar mitigaciÃ³n (con comprobaciÃ³n de tamaÃ±o)
len_h = array.size(liq_highs)
if len_h > 0
    for i = 0 to len_h - 1
        h = array.get(liq_highs, i)
        if not array.get(liq_high_mitigated, i) and close > h * (1 + liq_tolerance/100)
            array.set(liq_high_mitigated, i, true)
            array.set(liq_high_mitig_bar, i, bar_index)

len_l = array.size(liq_lows)
if len_l > 0
    for i = 0 to len_l - 1
        l = array.get(liq_lows, i)
        if not array.get(liq_low_mitigated, i) and close < l * (1 - liq_tolerance/100)
            array.set(liq_low_mitigated, i, true)
            array.set(liq_low_mitig_bar, i, bar_index)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ORDER BLOCKS (Zonas de InterÃ©s)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
group_ob = "ğŸ”¸ Order Blocks"
ob_lookback = input.int(8, "Lookback OB", minval=3, maxval=20, group=group_ob)
ob_min_size = input.float(0.5, "TamaÃ±o mÃ­nimo OB %", minval=0.1, step=0.1, group=group_ob)
use_volume = input.bool(true, "Filtrar por Volumen", group=group_ob)
max_ob = input.int(30, "MÃ¡ximo OB visual", minval=5, maxval=100, group=group_ob)

var float[] ob_highs = array.new_float(0)
var float[] ob_lows = array.new_float(0)
var int[] ob_bars = array.new_int(0)
var bool[] ob_mitigated = array.new_bool(0)
var int[] ob_mitig_bar = array.new_int(0)

// Detectar OB Alcista: vela bajista previa + movimiento alcista en lookback
momentum_up = (close - close[ob_lookback]) / close[ob_lookback] * 100
prev_bearish = open[1] > close[1]
strong_up = momentum_up >= ob_min_size
bull_ob = prev_bearish and strong_up and close > open

if use_ob and bull_ob
    ok = true
    if use_volume
        avg_vol = ta.sma(volume, 20)
        ok := volume[1] > avg_vol[1] * 1.2
    if ok
        array.push(ob_highs, high[1])
        array.push(ob_lows, low[1])
        array.push(ob_bars, bar_index[1])
        array.push(ob_mitigated, false)
        array.push(ob_mitig_bar, -1)

// Detectar OB Bajista: vela alcista previa + movimiento bajista
momentum_down = (close[ob_lookback] - close) / close * 100
prev_bullish = open[1] < close[1]
strong_down = momentum_down >= ob_min_size
bear_ob = prev_bullish and strong_down and close < open

if use_ob and bear_ob
    ok = true
    if use_volume
        avg_vol = ta.sma(volume, 20)
        ok := volume[1] > avg_vol[1] * 1.2
    if ok
        array.push(ob_highs, high[1])
        array.push(ob_lows, low[1])
        array.push(ob_bars, bar_index[1])
        array.push(ob_mitigated, false)
        array.push(ob_mitig_bar, -1)

// Limitar OB arrays
if array.size(ob_highs) > max_ob
    array.shift(ob_highs)
    array.shift(ob_lows)
    array.shift(ob_bars)
    array.shift(ob_mitigated)
    array.shift(ob_mitig_bar)

// Verificar mitigaciÃ³n OB
len_ob = array.size(ob_highs)
if len_ob > 0
    for i = 0 to len_ob - 1
        h = array.get(ob_highs, i)
        l = array.get(ob_lows, i)
        already = array.get(ob_mitigated, i)
        if not already
            mitigated = close <= h  // Bull OB: mitigate if price enters OB
            if not mitigated
                mitigated := close >= l  // Bear OB: mitigate if price enters OB
            if mitigated
                array.set(ob_mitigated, i, true)
                array.set(ob_mitig_bar, i, bar_index)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EMAs y cruces
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ema_fast = ta.ema(close, fast_ema_len)
ema_slow = ta.ema(close, slow_ema_len)
plot(ema_fast, color=color.new(color.orange, 0), title="EMA Fast")
plot(ema_slow, color=color.new(color.blue, 0), title="EMA Slow")

golden_cross = ta.crossover(ema_fast, ema_slow)
dead_cross = ta.crossunder(ema_fast, ema_slow)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETERMINAR SI HAY MITIGACIÃ“N RECIENTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
recent_liq_high_mitigated() =>
    var result = false
    result := false
    len_h = array.size(liq_highs)
    if len_h > 0
        for i = 0 to len_h - 1
            if array.get(liq_high_mitigated, i)
                mbar = array.get(liq_high_mitig_bar, i)
                if mbar >= 0 and bar_index - mbar <= bars_window
                    result := true
                    break
    result

recent_liq_low_mitigated() =>
    var result = false
    result := false
    len_l = array.size(liq_lows)
    if len_l > 0
        for i = 0 to len_l - 1
            if array.get(liq_low_mitigated, i)
                mbar = array.get(liq_low_mitig_bar, i)
                if mbar >= 0 and bar_index - mbar <= bars_window
                    result := true
                    break
    result

recent_ob_mitigated() =>
    var result = false
    result := false
    len_ob = array.size(ob_highs)
    if len_ob > 0
        for i = 0 to len_ob - 1
            if array.get(ob_mitigated, i)
                mbar = array.get(ob_mitig_bar, i)
                if mbar >= 0 and bar_index - mbar <= bars_window
                    result := true
                    break
    result

zone_liq_ok = not use_liq or (recent_liq_high_mitigated() or recent_liq_low_mitigated())
zone_ob_ok = not use_ob or recent_ob_mitigated()
zone_ok = zone_liq_ok and zone_ob_ok

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEÃ‘ALES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
long_signal = golden_cross and zone_ok
short_signal = dead_cross and zone_ok

plotshape(long_signal, title="Long Signal", location=location.belowbar,
          color=color.green, style=shape.triangleup, size=size.small)
plotshape(short_signal, title="Short Signal", location=location.abovebar,
          color=color.red, style=shape.triangledown, size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISUALIZACIÃ“N DE ZONAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Liquidez no mitigada: lÃ­neas horizontales finas grises
len_h_draw = array.size(liq_highs)
if len_h_draw > 0
    for i = 0 to len_h_draw - 1
        h = array.get(liq_highs, i)
        bar_h = array.get(liq_high_bars, i)
        mitigated = array.get(liq_high_mitigated, i)
        if not mitigated and bar_index - bar_h <= 30
            line.new(bar_h, h, bar_index + 15, h,
                     color=color.new(color.gray, 30), width=1)

len_l_draw = array.size(liq_lows)
if len_l_draw > 0
    for i = 0 to len_l_draw - 1
        l = array.get(liq_lows, i)
        bar_l = array.get(liq_low_bars, i)
        mitigated = array.get(liq_low_mitigated, i)
        if not mitigated and bar_index - bar_l <= 30
            line.new(bar_l, l, bar_index + 15, l,
                     color=color.new(color.gray, 30), width=1)

// Order Blocks no mitigados: cuadrados grises
len_ob_draw = array.size(ob_highs)
if len_ob_draw > 0
    for i = 0 to len_ob_draw - 1
        if not array.get(ob_mitigated, i)
            box.new(array.get(ob_bars, i), array.get(ob_highs, i),
                    bar_index + 30, array.get(ob_lows, i),
                    bgcolor=color.new(color.gray, 85),
                    border_color=color.gray,
                    border_width=1)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
alertcondition(long_signal, "Long Signal", "EMA crossover + zona mitigada (LONG)")
alertcondition(short_signal, "Short Signal", "EMA crossover + zona mitigada (SHORT)")
