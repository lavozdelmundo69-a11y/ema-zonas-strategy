// INDICADOR: EMA 3/22 + Zonas de Liquidez/InterÃ©s Mitigadas
// Muestra seÃ±ales visuales (triÃ¡ngulos) cuando se cumple la condiciÃ³n
// â€” Cruce EMA 3/22
// â€” Previamente se mitigÃ³ una zona (liquidez o FVG) en ventana de N barras
// No ejecuta trades; solo visualizaciÃ³n para charting
//@version=6
indicator("EMA 3/22 + Zonas Mitigadas (SeÃ±ales)", overlay=true)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARÃMETROS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
fast_ema_len = input.int(3, "EMA RÃ¡pida", group="ğŸ“Š EMAs")
slow_ema_len = input.int(22, "EMA Lenta", group="ğŸ“Š EMAs")
bars_window = input.int(10, "Ventana post-mitigaciÃ³n (barras)", minval=1, maxval=50,
     tooltip="MÃ¡ximo barras despuÃ©s de mitigar zona para considerar vÃ¡lido el cruce")

use_liq = input.bool(true, "Detectar Zonas de Liquidez", group="ğŸ” Condiciones")
use_fvg = input.bool(true, "Detectar Zonas de InterÃ©s (FVG)", group="ğŸ” Condiciones")

group_liq = "ğŸ”¹ Zonas de Liquidez"
swing_len = input.int(16, "Longitud Swing High/Low", group=group_liq, minval=5, maxval=50)
liq_tolerance = input.float(0.5, "Tolerancia MitigaciÃ³n (%)", group=group_liq, minval=0.1, step=0.1)
max_zonas = input.int(20, "MÃ¡ximo Zonas Visual", group=group_liq, minval=5, maxval=50)

group_fvg = "ğŸ”¸ Zonas de InterÃ©s FVG"
sens_fvg = input.float(0.5, "TamaÃ±o MÃ­nimo FVG (%)", group=group_fvg, minval=0.1, step=0.1)
extender_fvg = input.int(20, "Extender FVG (barras)", group=group_fvg, minval=10)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EMAs y cruces
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ema_fast = ta.ema(close, fast_ema_len)
ema_slow = ta.ema(close, slow_ema_len)
plot(ema_fast, color=color.new(color.orange, 0), title="EMA Fast")
plot(ema_slow, color=color.new(color.blue, 0), title="EMA Slow")

golden_cross = ta.crossover(ema_fast, ema_slow)
dead_cross = ta.crossunder(ema_fast, ema_slow)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ARRAYS DE ZONAS (persistentes)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var float[] liq_highs = array.new_float(0)
var float[] liq_lows = array.new_float(0)
var int[] liq_high_bars = array.new_int(0)
var int[] liq_low_bars = array.new_int(0)
var bool[] liq_high_mitigated = array.new_bool(0)
var bool[] liq_low_mitigated = array.new_bool(0)
var int[] liq_high_mitig_bar = array.new_int(0)
var int[] liq_low_mitig_bar = array.new_int(0)

var float[] fvg_tops = array.new_float(0)
var float[] fvg_bottoms = array.new_float(0)
var int[] fvg_bars = array.new_int(0)
var bool[] fvg_mitigated = array.new_bool(0)
var int[] fvg_mitig_bar = array.new_int(0)
var bool[] fvg_is_bull = array.new_bool(0)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETECCIÃ“N PIVOTS (sin lookahead)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// En Pine, ta.pivothigh/pivotlow ya devuelven na si no es pivot
top = ta.pivothigh(high, swing_len, swing_len)
bot = ta.pivotlow(low, swing_len, swing_len)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 1) AÃ‘ADIR NUEVAS ZONAS AL DETECTAR PIVOTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if not na(top)
    array.push(liq_highs, top)
    array.push(liq_high_bars, bar_index[swing_len])
    array.push(liq_high_mitigated, false)
    array.push(liq_high_mitig_bar, -1)

if not na(bot)
    array.push(liq_lows, bot)
    array.push(liq_low_bars, bar_index[swing_len])
    array.push(liq_low_mitigated, false)
    array.push(liq_low_mitig_bar, -1)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 2) LIMPIAR ARRAYS ANTES DE CUALQUIER ITERACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if array.size(liq_highs) > max_zonas
    array.shift(liq_highs)
    array.shift(liq_high_bars)
    array.shift(liq_high_mitigated)
    array.shift(liq_high_mitig_bar)

if array.size(liq_lows) > max_zonas
    array.shift(liq_lows)
    array.shift(liq_low_bars)
    array.shift(liq_low_mitigated)
    array.shift(liq_low_mitig_bar)

if array.size(fvg_tops) > max_zonas
    array.shift(fvg_tops)
    array.shift(fvg_bottoms)
    array.shift(fvg_bars)
    array.shift(fvg_mitigated)
    array.shift(fvg_mitig_bar)
    array.shift(fvg_is_bull)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3) VERIFICAR MITIGACIONES (ITERAR solo si hay elementos)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
len_liq_h = array.size(liq_highs)
if len_liq_h > 0
    for i = 0 to len_liq_h - 1
        h = array.get(liq_highs, i)
        if not array.get(liq_high_mitigated, i) and close > h * (1 + liq_tolerance/100)
            array.set(liq_high_mitigated, i, true)
            array.set(liq_high_mitig_bar, i, bar_index)

len_liq_l = array.size(liq_lows)
if len_liq_l > 0
    for i = 0 to len_liq_l - 1
        l = array.get(liq_lows, i)
        if not array.get(liq_low_mitigated, i) and close < l * (1 - liq_tolerance/100)
            array.set(liq_low_mitigated, i, true)
            array.set(liq_low_mitig_bar, i, bar_index)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 4) DETECCIÃ“N FVG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bull_fvg = low > high[2] and close[1] > open[1]
bear_fvg = high < low[2] and close[1] < open[1]

bull_size = bull_fvg ? (low - high[2]) / high[2] * 100 : 0
bear_size = bear_fvg ? (low[2] - high) / high * 100 : 0

valid_bull = bull_fvg and bull_size >= sens_fvg
valid_bear = bear_fvg and bear_size >= sens_fvg

if valid_bull
    array.push(fvg_tops, low)
    array.push(fvg_bottoms, high[2])
    array.push(fvg_bars, bar_index[1])
    array.push(fvg_mitigated, false)
    array.push(fvg_mitig_bar, -1)
    array.push(fvg_is_bull, true)

if valid_bear
    array.push(fvg_tops, low[2])
    array.push(fvg_bottoms, high)
    array.push(fvg_bars, bar_index[1])
    array.push(fvg_mitigated, false)
    array.push(fvg_mitig_bar, -1)
    array.push(fvg_is_bull, false)

// Limpieza FVG tras push (ya no se itera, solo tamaÃ±o)
len_fvg = array.size(fvg_tops)
if len_fvg > max_zonas
    array.shift(fvg_tops)
    array.shift(fvg_bottoms)
    array.shift(fvg_bars)
    array.shift(fvg_mitigated)
    array.shift(fvg_mitig_bar)
    array.shift(fvg_is_bull)

// Verificar mitigaciÃ³n FVG (solo si hay zonas)
len_fvg2 = array.size(fvg_tops)
if len_fvg2 > 0
    for i = 0 to len_fvg2 - 1
        top = array.get(fvg_tops, i)
        bot = array.get(fvg_bottoms, i)
        is_bull = array.get(fvg_is_bull, i)
        if not array.get(fvg_mitigated, i)
            mitigated = is_bull ? close <= top : close >= bot
            if mitigated
                array.set(fvg_mitigated, i, true)
                array.set(fvg_mitig_bar, i, bar_index)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 5) FUNCIONES DE MITIGACIÃ“N RECIENTE (con comprobaciÃ³n size>0)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
recent_liq_high_mitigated() =>
    var result = false
    result := false
    len_h = array.size(liq_highs)
    if len_h > 0
        for i = 0 to len_h - 1
            if array.get(liq_high_mitigated, i)
                mbar = array.get(liq_high_mitig_bar, i)
                if mbar >= 0 and bar_index - mbar <= bars_window
                    result := true
                    break
    result

recent_liq_low_mitigated() =>
    var result = false
    result := false
    len_l = array.size(liq_lows)
    if len_l > 0
        for i = 0 to len_l - 1
            if array.get(liq_low_mitigated, i)
                mbar = array.get(liq_low_mitig_bar, i)
                if mbar >= 0 and bar_index - mbar <= bars_window
                    result := true
                    break
    result

recent_fvg_mitigated() =>
    var result = false
    result := false
    len_f = array.size(fvg_tops)
    if len_f > 0
        for i = 0 to len_f - 1
            if array.get(fvg_mitigated, i)
                mbar = array.get(fvg_mitig_bar, i)
                if mbar >= 0 and bar_index - mbar <= bars_window
                    result := true
                    break
    result

zone_liq_ok = not use_liq or (recent_liq_high_mitigated() or recent_liq_low_mitigated())
zone_fvg_ok = not use_fvg or recent_fvg_mitigated()
zone_ok = zone_liq_ok and zone_fvg_ok

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 6) SEÃ‘ALES (solo visuales, no trading)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
long_signal = golden_cross and zone_ok
short_signal = dead_cross and zone_ok

plotshape(long_signal, title="Long Signal", location=location.belowbar,
          color=color.green, style=shape.triangleup, size=size.small)
plotshape(short_signal, title="Short Signal", location=location.abovebar,
          color=color.red, style=shape.triangledown, size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 7) VISUALIZACIÃ“N DE ZONAS (solo si hay zonas)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Liquidez no mitigada
len_h_draw = array.size(liq_highs)
if len_h_draw > 0
    for i = 0 to len_h_draw - 1
        h = array.get(liq_highs, i)
        bar_h = array.get(liq_high_bars, i)
        mitigated = array.get(liq_high_mitigated, i)
        if not mitigated and bar_index - bar_h <= 30
            line.new(bar_h, h, bar_index + 15, h,
                     color=color.new(color.red, 60), width=1)

len_l_draw = array.size(liq_lows)
if len_l_draw > 0
    for i = 0 to len_l_draw - 1
        l = array.get(liq_lows, i)
        bar_l = array.get(liq_low_bars, i)
        mitigated = array.get(liq_low_mitigated, i)
        if not mitigated and bar_index - bar_l <= 30
            line.new(bar_l, l, bar_index + 15, l,
                     color=color.new(color.green, 60), width=1)

// FVGs no mitigados
len_fvg_draw = array.size(fvg_tops)
if len_fvg_draw > 0
    for i = 0 to len_fvg_draw - 1
        if not array.get(fvg_mitigated, i)
            box.new(array.get(fvg_bars, i), array.get(fvg_tops, i),
                    bar_index + extender_fvg, array.get(fvg_bottoms, i),
                    bgcolor=color.new(color.gray, 85), border_color=color.gray)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 8) ALERTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
alertcondition(long_signal, "Long Signal", "EMA crossover + zona mitigada (LONG)")
alertcondition(short_signal, "Short Signal", "EMA crossover + zona mitigada (SHORT)")
